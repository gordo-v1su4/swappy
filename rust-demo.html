<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swappy Rust Backend Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .upload-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .upload-box {
            flex: 1;
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
        }
        .upload-box:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .results {
            margin-top: 20px;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .video-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        .video-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
        }
        .markers {
            height: 200px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }
        .marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #007bff;
            opacity: 0.7;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>🚀 Swappy Rust Backend Demo</h1>
    
    <div class="container">
        <h2>Server Status</h2>
        <button onclick="checkHealth()">Check Health</button>
        <div id="health-status" class="status"></div>
    </div>

    <div class="container">
        <h2>Upload Files</h2>
        <div class="upload-section">
            <div class="upload-box">
                <h3>📹 Upload Video</h3>
                <input type="file" id="video-file" accept="video/*">
                <br><br>
                <button onclick="uploadVideo()">Upload Video</button>
            </div>
            <div class="upload-box">
                <h3>🎵 Upload Audio</h3>
                <input type="file" id="audio-file" accept="audio/*">
                <br><br>
                <button onclick="uploadAudio()">Upload Audio</button>
            </div>
        </div>
        <div id="upload-status" class="status"></div>
    </div>

    <div class="container">
        <h2>Videos</h2>
        <button onclick="loadVideos()">Refresh Videos</button>
        <div id="video-grid" class="video-grid"></div>
    </div>

    <div class="container">
        <h2>Audio Analysis</h2>
        <label for="audio-id">Audio ID:</label>
        <input type="text" id="audio-id" placeholder="Enter audio ID">
        <label for="sensitivity">Sensitivity (0-1):</label>
        <input type="range" id="sensitivity" min="0" max="1" step="0.1" value="0.5">
        <span id="sensitivity-value">0.5</span>
        <br><br>
        <button onclick="analyzeAudio()">Analyze Audio</button>
        <div id="analysis-results" class="results">
            <div id="markers-container" class="markers"></div>
            <div id="analysis-info"></div>
        </div>
    </div>

    <div class="container">
        <h2>Debug Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:3002';
        let currentAudioId = null;

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function showStatus(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${isError ? 'error' : 'success'}`;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }

        async function checkHealth() {
            try {
                log('Checking server health...');
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                showStatus('health-status', `✅ ${data.message}`);
                log(`Health check: ${data.status} - ${data.message}`);
            } catch (error) {
                showStatus('health-status', `❌ Server unavailable: ${error.message}`, true);
                log(`Health check failed: ${error.message}`);
            }
        }

        async function uploadVideo() {
            const fileInput = document.getElementById('video-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('upload-status', 'Please select a video file', true);
                return;
            }

            try {
                log(`Uploading video: ${file.name} (${file.size} bytes)`);
                const formData = new FormData();
                formData.append('video', file);

                const response = await fetch(`${API_BASE}/api/upload/video`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                showStatus('upload-status', `✅ Video uploaded: ${data.filename}`);
                log(`Video uploaded successfully: ${data.id}`);
                
                // Auto-refresh videos
                loadVideos();
            } catch (error) {
                showStatus('upload-status', `❌ Upload failed: ${error.message}`, true);
                log(`Video upload failed: ${error.message}`);
            }
        }

        async function uploadAudio() {
            const fileInput = document.getElementById('audio-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('upload-status', 'Please select an audio file', true);
                return;
            }

            try {
                log(`Uploading audio: ${file.name} (${file.size} bytes)`);
                const formData = new FormData();
                formData.append('audio', file);

                const response = await fetch(`${API_BASE}/api/upload/audio`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                showStatus('upload-status', `✅ Audio uploaded: ${data.filename}`);
                log(`Audio uploaded successfully: ${data.id}`);
                
                // Auto-populate audio ID field
                document.getElementById('audio-id').value = data.id;
                currentAudioId = data.id;
            } catch (error) {
                showStatus('upload-status', `❌ Upload failed: ${error.message}`, true);
                log(`Audio upload failed: ${error.message}`);
            }
        }

        async function loadVideos() {
            try {
                log('Loading videos...');
                const response = await fetch(`${API_BASE}/api/videos`);
                const videos = await response.json();
                
                const grid = document.getElementById('video-grid');
                grid.innerHTML = '';
                
                videos.forEach(video => {
                    const videoItem = document.createElement('div');
                    videoItem.className = 'video-item';
                    videoItem.innerHTML = `
                        <img src="${API_BASE}/api/videos/${video.id}/thumbnail" alt="Thumbnail">
                        <h4>${video.filename}</h4>
                        <p>Size: ${(video.size / 1024).toFixed(1)} KB</p>
                        <p>ID: ${video.id.substring(0, 8)}...</p>
                    `;
                    grid.appendChild(videoItem);
                });
                
                log(`Loaded ${videos.length} videos`);
            } catch (error) {
                log(`Failed to load videos: ${error.message}`);
            }
        }

        async function analyzeAudio() {
            const audioId = document.getElementById('audio-id').value;
            const sensitivity = parseFloat(document.getElementById('sensitivity').value);
            
            if (!audioId) {
                showStatus('upload-status', 'Please enter an audio ID', true);
                return;
            }

            try {
                log(`Analyzing audio: ${audioId} with sensitivity ${sensitivity}`);
                const response = await fetch(`${API_BASE}/api/audio/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        audio_id: audioId,
                        sensitivity: sensitivity
                    })
                });

                const data = await response.json();
                
                // Display markers
                const markersContainer = document.getElementById('markers-container');
                markersContainer.innerHTML = '';
                
                const duration = data.duration;
                data.markers.forEach(markerTime => {
                    const marker = document.createElement('div');
                    marker.className = 'marker';
                    marker.style.left = `${(markerTime / duration) * 100}%`;
                    marker.title = `${markerTime.toFixed(2)}s`;
                    markersContainer.appendChild(marker);
                });
                
                // Display analysis info
                const infoElement = document.getElementById('analysis-info');
                infoElement.innerHTML = `
                    <h4>Analysis Results</h4>
                    <p><strong>Duration:</strong> ${data.duration.toFixed(2)} seconds</p>
                    <p><strong>Sample Rate:</strong> ${data.sample_rate} Hz</p>
                    <p><strong>Markers Found:</strong> ${data.markers.length}</p>
                    <p><strong>Average Marker Spacing:</strong> ${(data.duration / data.markers.length).toFixed(2)} seconds</p>
                `;
                
                log(`Audio analysis complete: ${data.markers.length} markers found`);
            } catch (error) {
                showStatus('upload-status', `❌ Analysis failed: ${error.message}`, true);
                log(`Audio analysis failed: ${error.message}`);
            }
        }

        // Update sensitivity value display
        document.getElementById('sensitivity').addEventListener('input', function() {
            document.getElementById('sensitivity-value').textContent = this.value;
        });

        // Auto-check health on load
        window.addEventListener('load', function() {
            checkHealth();
            loadVideos();
        });
    </script>
</body>
</html>